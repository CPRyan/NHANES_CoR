---
title: "NHANES Data Download"
author: "Waylon J. Hastings"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

**Activating RNHANES Package** 

```{r, include=FALSE}
library(RNHANES)
```

#Downloading demographic, control, and biomarker files#

```{r, include=FALSE}
DEMO <- nhanes_load_data(c("DEMO","DEMO_B","DEMO_C","DEMO_D","DEMO_E","DEMO_F","DEMO_G","DEMO_H","DEMO_I"),c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2011-2012","2013-2014","2015-2016"))

BMI <- nhanes_load_data(c("BMX","BMX_B","BMX_C","BMX_D","BMX_E","BMX_F","BMX_G","BMX_H","BMX_I"),c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2011-2012","2013-2014","2015-2016"))

CRP <- nhanes_load_data(c("LAB11","L11_B","L11_C","CRP_D","CRP_E","CRP_F","HSCRP_I"), c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2015-2016"))

creatinine <- nhanes_load_data(c("LAB18","L40_B","L40_C","BIOPRO_D","BIOPRO_E","BIOPRO_F","BIOPRO_G","BIOPRO_H","BIOPRO_I"), c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2011-2012","2013-2014","2015-2016"))

gluc <- nhanes_load_data(c("LAB10AM","L10AM_B","L10AM_C","GLU_D","GLU_E","GLU_F","GLU_G","GLU_H","INS_H","GLU_I","INS_I"), c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2011-2012","2013-2014","2013-2014","2015-2016","2015-2016"))

CBC <- nhanes_load_data(c("LAB25","L25_B","L25_C","CBC_D","CBC_E","CBC_F","CBC_G","CBC_H","CBC_I"),c("1999-2000","2001-2002","2003-2004","2005-2006","2007-2008","2009-2010","2011-2012","2013-2014","2015-2016"))
```

#Extracting Demographic Variables#

```{r}
library(dplyr)
Demo_1999 <- dplyr::select(DEMO$DEMO,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
#Adding a dummy variable to hold sample wave 
Demo_1999 <- dplyr::transmute(Demo_1999,SEQN=SEQN,WAVE=(SEQN*0+1),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)

Demo_2001 <- dplyr::select(DEMO$DEMO_B,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
Demo_2001 <- dplyr::transmute(Demo_2001,SEQN=SEQN,WAVE=(SEQN*0+2),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)

Demo_2003 <- dplyr::select(DEMO$DEMO_C,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
Demo_2003 <- dplyr::transmute(Demo_2003,SEQN=SEQN,WAVE=(SEQN*0+3),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)

Demo_2005 <- dplyr::select(DEMO$DEMO_D,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
Demo_2005 <- dplyr::transmute(Demo_2005,SEQN=SEQN,WAVE=(SEQN*0+4),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)

Demo_2007 <- dplyr::select(DEMO$DEMO_E,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
Demo_2007 <- dplyr::transmute(Demo_2007,SEQN=SEQN,WAVE=(SEQN*0+5),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)

Demo_2009 <- dplyr::select(DEMO$DEMO_F,SEQN,RIAGENDR,RIDAGEYR,RIDRETH1,DMDEDUC2,INDFMPIR,RIDEXPRG)
Demo_2009 <- dplyr::transmute(Demo_2009,SEQN=SEQN,WAVE=(SEQN*0+6),RIAGENDR=RIAGENDR,RIDAGEYR=RIDAGEYR,RIDRETH1=RIDRETH1,DMDEDUC2=DMDEDUC2,INDFMPIR=INDFMPIR,RIDEXPRG=RIDEXPRG)


#Combining demographics into one dataframe for all waves 
Demographics_ALL <- dplyr::bind_rows(Demo_1999,Demo_2001,Demo_2003,Demo_2005,Demo_2007,Demo_2009)
Demographics_ALL <- dplyr::transmute(Demographics_ALL,SEQN=SEQN,WAVE=WAVE,Gender=RIAGENDR,Age=RIDAGEYR,Ethnicity=RIDRETH1,Education=DMDEDUC2,PovertyIncome=INDFMPIR,Pregnant=RIDEXPRG)
summary(Demographics_ALL)
dim(Demographics_ALL)

#Recoding pregnancy variable to be nonpregnant for all men and for individuals of uncertain pregnancy status  
Demographics_ALL$Pregnant[Demographics_ALL$Pregnant==3] <- 2
Demographics_ALL$Pregnant[is.na(Demographics_ALL$Pregnant)] <- 2

#Recoding missing or nonresponse indicators to NA
Demographics_ALL$Education[Demographics_ALL$Education==7] <- NA
Demographics_ALL$Education[Demographics_ALL$Education==9] <- NA
Demographics_ALL$PovertyIncome[Demographics_ALL$PovertyIncome==0] <- NA
```

#Extracting BMI & Body Measure Variables#

```{r}
BMI_1999 <- dplyr::select(BMI$BMX,SEQN,BMXBMI,BMXHT,BMXWAIST)
BMI_2001 <- dplyr::select(BMI$BMX_B,SEQN,BMXBMI,BMXHT,BMXWAIST)
BMI_2003 <- dplyr::select(BMI$BMX_C,SEQN,BMXBMI,BMXHT,BMXWAIST)
BMI_2005 <- dplyr::select(BMI$BMX_D,SEQN,BMXBMI,BMXHT,BMXWAIST)
BMI_2007 <- dplyr::select(BMI$BMX_E,SEQN,BMXBMI,BMXHT,BMXWAIST)
BMI_2009 <- dplyr::select(BMI$BMX_F,SEQN,BMXBMI,BMXHT,BMXWAIST)

BMI_ALL <- dplyr::bind_rows(BMI_1999,BMI_2001,BMI_2003,BMI_2005,BMI_2007,BMI_2009)
BMI_ALL <- dplyr::transmute(BMI_ALL,SEQN=SEQN,BMI=BMXBMI,Height=BMXHT,Waist=BMXWAIST)
summary(BMI_ALL)
dim(BMI_ALL)
```


#Extracting CRP#
CRP is listed in units of mg/dL, but was only measured through the 2009-2010 cycle. The lower limit of detection for all the CRP assays is 0.01 so I'll recode these values to missing. 

```{r}
CRP_1999 <- dplyr::select(CRP$LAB11,SEQN,LBXCRP)
CRP_2001 <- dplyr::select(CRP$L11_B,SEQN,LBXCRP)
CRP_2003 <- dplyr::select(CRP$L11_C,SEQN,LBXCRP)
CRP_2005 <- dplyr::select(CRP$CRP_D,SEQN,LBXCRP)
CRP_2007 <- dplyr::select(CRP$CRP_E,SEQN,LBXCRP)
CRP_2009 <- dplyr::select(CRP$CRP_F,SEQN,LBXCRP)

#Recoding indicators for the lower limit of detection to missing 
CRP_1999$LBXCRP[CRP_1999$LBXCRP<=0.01] <- NA
CRP_2001$LBXCRP[CRP_2001$LBXCRP<=0.01] <- NA
CRP_2003$LBXCRP[CRP_2003$LBXCRP<=0.01] <- NA
CRP_2005$LBXCRP[CRP_2005$LBXCRP<=0.01] <- NA
CRP_2007$LBXCRP[CRP_2007$LBXCRP<=0.01] <- NA
CRP_2009$LBXCRP[CRP_2009$LBXCRP<=0.01] <- NA

CRP_ALL <- dplyr::bind_rows(CRP_1999,CRP_2001,CRP_2003,CRP_2005,CRP_2007,CRP_2009)

#Creating log-transformed creatinine variable
CRP_ALL <- dplyr::transmute(CRP_ALL,SEQN=SEQN,CRP=LBXCRP,Ln_CRP=log(LBXCRP))
summary(CRP_ALL)
dim(CRP_ALL)
```

#Extracting Creatinine, Albumin, and Alkaline Phosphatase Variables#

Creatinine values from the 1999-2000 wave are corrected based on Analytical Notes posted by NHANES [here](https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB18.htm). Creatinine values from the 2005-2006 wave of NHANES were measured using different instrumentation. As such a correction equation was recommended for 2005-2006 wave creatinine values. This equation is given in [this publication](https://www.ncbi.nlm.nih.gov/pubmed/28265873) and is the same as the one listed on the NHANES webpage [here](https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/BIOPRO_D.htm). These values are listed in units of mg/dL and will need to be converted to units of umol/L to match the parameters for PhenoAge. 

```{r}
#Variable names are creatinine in mg/dL (LBXSCR; needs to be converted to umol/L), albumin in g/L (LBDSALSI), and alkaline phosphatase in U/L (LBXSAPSI)

creatinine_1999 <- dplyr::select(creatinine$LAB18,SEQN,LBXSCR,LBDSALSI,LBXSAPSI)
#Correcting 1999 creatinine using the recommended equation 
creatinine_1999 <- dplyr::mutate(creatinine_1999,SEQN=SEQN, LBXSCR=(1.013*LBXSCR+0.147),LBDSALSI=LBDSALSI,LBXSAPSI=LBXSAPSI)

creatinine_2001 <- dplyr::select(creatinine$L40_B,SEQN,LBDSCR,LBDSALSI,LBDSAPSI)
colnames(creatinine_2001) <- colnames(creatinine_1999)
creatinine_2003 <- dplyr::select(creatinine$L40_C,SEQN,LBXSCR,LBDSALSI,LBXSAPSI)
creatinine_2005 <- dplyr::select(creatinine$BIOPRO_D,SEQN,LBXSCR,LBDSALSI,LBXSAPSI)

#Correcting 2005 creatinine using the recommended equation.  
creatinine_2005 <- dplyr::mutate(creatinine_2005,SEQN=SEQN,LBXSCR=(-0.016+0.978*LBXSCR),LBDSALSI=LBDSALSI,LBXSAPSI=LBXSAPSI)

creatinine_2007 <- dplyr::select(creatinine$BIOPRO_E,SEQN,LBXSCR,LBDSALSI,LBXSAPSI)
creatinine_2009 <- dplyr::select(creatinine$BIOPRO_F,SEQN,LBXSCR,LBDSALSI,LBXSAPSI)

creatinine_ALL <- dplyr::bind_rows(creatinine_1999,creatinine_2001,creatinine_2003,creatinine_2005,creatinine_2007,creatinine_2009)

#Creating informative names 
colnames(creatinine_ALL) <- c("SEQN","Creatinine","Albumin","Alkaline_Phosphatase")
dim(creatinine_ALL)
summary(creatinine_ALL)
```

#Extracting Glucose#
The measurement methods for glucose, and especially insulin were widely changes across NHANES waves. 

Adjustment of glucose involves multiple regression equations as the methodology changes 3 times between 1999 and 2016. First, 1999-2004 values must be adjusted to reflect changes to the methodology for 2005-2006 such that all values are equivalent to measures from the "Hitachi 911" [see here](https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/GLU_D.htm). Next, all values prior to 2007 must be adjusted to reflect changes in methodology for 2007-2008 such that all values are equivalent to measures from the "Roche ModP" [see here](https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/GLU_E.htm).  

Extracted glucose values are in units of mg/dL and need to be converted to mmol/L. 


```{r}
gluc_1999 <- dplyr::select(gluc$LAB10AM,SEQN,LBXGLU)
gluc_2001 <- dplyr::select(gluc$L10AM_B,SEQN,LBXGLU)

#Combining
gluc_early <- dplyr::bind_rows(gluc_1999,gluc_2001)
gluc_early <- dplyr::mutate(gluc_early,SEQN=SEQN,LBXGLU=LBXGLU)

gluc_2003 <- dplyr::select(gluc$L10AM_C,SEQN,LBXGLU)

#Combining 2003 measures with 1999-2002 and adjusting glucose to match 2005 methods
gluc_middle <- dplyr::bind_rows(gluc_early,gluc_2003)
gluc_middle <- dplyr::mutate(gluc_middle,SEQN=SEQN,LBXGLU=(LBXGLU*0.9815+3.5707))

gluc_2005 <- dplyr::select(gluc$GLU_D,SEQN,LBXGLU)

# Combining pre-2007 measures and adjusting glucose such that all glucose results should be in line with 2007 methodology
gluc_pre2007 <- dplyr::bind_rows(gluc_middle,gluc_2005)
gluc_pre2007 <- dplyr::transmute(gluc_pre2007,SEQN=SEQN,LBXGLU=LBXGLU+1.148)


gluc_2007 <- dplyr::select(gluc$GLU_E,SEQN,LBXGLU)
gluc_2009 <- dplyr::select(gluc$GLU_F,SEQN,LBXGLU)

#Combining measures 
gluc_ALL <- dplyr::bind_rows(gluc_pre2007,gluc_2007,gluc_2009)

#Making informative variable names 
gluc_ALL <- dplyr::transmute(gluc_ALL,SEQN=SEQN,glucose=LBXGLU)
dim(gluc_ALL)
summary(gluc_ALL)
```

#DOWNLOADING CBC BIOMAKRERS#

```{r}
cbc_1999 <- dplyr::select(CBC$LAB25,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_2001 <- dplyr::select(CBC$L25_B,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_2003 <- dplyr::select(CBC$L25_C,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_2005 <- dplyr::select(CBC$CBC_D,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_2007 <- dplyr::select(CBC$CBC_E,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_2009 <- dplyr::select(CBC$CBC_F,SEQN,LBXLYPCT,LBXWBCSI,LBXMCVSI,LBXRDW)
cbc_ALL <- dplyr::bind_rows(cbc_1999,cbc_2001,cbc_2003,cbc_2005,cbc_2007,cbc_2009)

#LLOD and ULOD values were not listed by NHANES until the 2015 cycle. To be safe I will remove values below and above these limits respectively from all cycles. This isn't a problem with lymphocyte percent (LBXLYPCT) since the limits are 0% and 100%
cbc_ALL$LBXWBCSI[cbc_ALL$LBXWBCSI<=0.050] <- NA 
cbc_ALL$LBXWBCSI[cbc_ALL$LBXWBCSI>=400] <- NA
cbc_ALL$LBXMCVSI[cbc_ALL$LBXMCVSI<=50.00] <- NA
cbc_ALL$LBXMCVSI[cbc_ALL$LBXMCVSI>=150.00] <- NA
cbc_ALL$LBXRDW[cbc_ALL$LBXRDW<=10.00] <- NA
cbc_ALL$LBXRDW[cbc_ALL$LBXRDW>=40.00] <- NA

#Adding informative column names
cbc_ALL <- dplyr::transmute(cbc_ALL,SEQN=SEQN,Lymphocyte_percent=LBXLYPCT,White_Count=LBXWBCSI,MCV=LBXMCVSI,Red_Cell_Width=LBXRDW)
```

#Combining NHANES Continuous Data and removing extraneous datafiles#

```{r}
Step1 <- dplyr::full_join(Demographics_ALL,BMI_ALL,by="SEQN")
Step2 <- dplyr::full_join(Step1,CRP_ALL,by="SEQN")
Step3 <- dplyr::full_join(Step2,creatinine_ALL,by="SEQN")
Step4 <- dplyr::full_join(Step3,gluc_ALL,by="SEQN")
Data_continuous <- dplyr::full_join(Step4,cbc_ALL,by="SEQN")

#Converting creatinine from mg/dL to umol/L
Data_continuous$PHENO_Creatinine <- Data_continuous$Creatinine*88.42
#Converting glucose from mg/dL to mmol/L
Data_continuous$PHENO_Glucose <- Data_continuous$glucose*0.05551

dim(Data_continuous)
summary(Data_continuous)

#Removing extraneous files from global environment
rm(DEMO,Demo_1999,Demo_2001,Demo_2003,Demo_2005,Demo_2007,Demo_2009,BMI,BMI_1999,BMI_2001,BMI_2003,BMI_2005,BMI_2007,BMI_2009,CRP,CRP_1999,CRP_2001,CRP_2003,CRP_2005,CRP_2007,CRP_2009,creatinine,creatinine_1999,creatinine_2001,creatinine_2003,creatinine_2005,creatinine_2007,creatinine_2009,gluc,gluc_1999,gluc_2001,gluc_2003,gluc_2005,gluc_2007,gluc_2009,gluc_early,gluc_middle,gluc_pre2007,CBC,cbc_1999,cbc_2001,cbc_2003,cbc_2005,cbc_2007,cbc_2009,Step1,Step2,Step3,Step4)
```


#IMPORTING NHANES III DATA#

In addition to the NHANES continuous panels, I also need to download data from NHANES III, the longitudinal study initiated prior to the panels from 1988-1994. Unfortunately, I cannot use the RNHANES package to do this. The data is posted as .dat files with corresponding SAS code to build a SAS dataset. I built these datasets using SAS and exported them as .csv files. 

**Loading datafiles**
NOTE: I may need to occassionally change the file path depending on what drive the USB is assigned. 

```{r}
adult <- read.csv(file.choose(),header=TRUE,sep=",")
exam <- read.csv(file.choose(),header=TRUE,sep=",")
lab <- read.csv(file.choose(),header=TRUE,sep=",")
```

#Extracting demographic and body measure data from NHANES III#
NOTE: Age is top coded at 90 in NHANES III. Ethnicity is coded such that 1=Non-hispanic White, 2=Non-hispanic Black, 3=Mexican-American, and 4=Other.

```{r}
Demo_III <- dplyr::select(adult,SEQN,HSSEX,HSAGEIR,DMARETHN,HFA8R,DMPPIR)
#Adding a wave variable and informative variable names to match those in the continuous NHANES panels data file 
Demo_III <- dplyr::transmute(Demo_III,SEQN=SEQN,WAVE=SEQN*0+10,Gender=HSSEX,Age=HSAGEIR,Ethnicity=DMARETHN,Education=HFA8R,PovertyIncome=DMPPIR)

#Recoding missing indicators for Education (88 & 99) and PovertyIncome (888888 & 00.000) to NA. 
Demo_III$Education[Demo_III$Education==88] <- NA
Demo_III$Education[Demo_III$Education==99] <- NA
Demo_III$PovertyIncome[Demo_III$PovertyIncome==888888] <- NA
Demo_III$PovertyIncome[Demo_III$PovertyIncome==00.000] <- NA

BMI_III <- dplyr::select(exam,SEQN,MAPF12R,BMPBMI,BMPHT,BMPWAIST)
BMI_III <- dplyr::transmute(BMI_III,SEQN=SEQN,Pregnant=MAPF12R,BMI=BMPBMI,Height=BMPHT,Waist=BMPWAIST)


#Recoding pregnancy variable to be nonpregnant for all men and for individuals of uncertain pregnancy status  
BMI_III$Pregnant[BMI_III$Pregnant==8] <- 2
BMI_III$Pregnant[BMI_III$Pregnant==9] <- 2
BMI_III$Pregnant[is.na(BMI_III$Pregnant)] <- 2

#Recoding BMI (8888), Height (88888), and Waist (88888) missing indicators to NA 
BMI_III$BMI[BMI_III$BMI==8888] <- NA
BMI_III$Height[BMI_III$Height==88888] <- NA
BMI_III$Waist[BMI_III$Waist==88888] <- NA

#Combining demographic and body measure items into one dataframe
Step1_III <- dplyr::left_join(Demo_III,BMI_III,by="SEQN")
```

#Extracting NHANES III biomarker data#
According to [this publication](https://www.sciencedirect.com/science/article/abs/pii/S0272638607012449) serum creatinine from NHANES III needs to be adjusted to match standardized measurements. 

```{r}
#Biomarkers extracted are CRP in mg/dL (CRP), creatinine in mg/dL (CEP), Albumin in g/L (AMPSI), Alkaline Phosphatase in U/L (APPSI), & glucose in mg/dL (G1P). Creatinine needs to be converted to umol/L and glucose needs to be converted to mmol/L prior to calculating BA measures. 

Bio_III <- dplyr::select(lab,SEQN,CRP,CEP,AMPSI,APPSI,G1P)

#Adding informative names,  
Bio_III <- dplyr::transmute(Bio_III,SEQN=SEQN,CRP=CRP,Creatinine=CEP,Albumin=AMPSI,Alkaline_Phosphatase=APPSI,glucose=G1P)


#Recoding NHANES III blank indicators, values below the LLOD, and values above the ULOD, to missing. 
Bio_III$CRP[Bio_III$CRP<=0.021] <- NA
Bio_III$CRP[Bio_III$CRP==88888] <- NA
Bio_III$Creatinine[Bio_III$Creatinine==8888] <- NA
Bio_III$glucose[Bio_III$glucose==88888] <- NA
Bio_III$Albumin[Bio_III$Albumin==888] <- NA
Bio_III$Alkaline_Phosphatase[Bio_III$Alkaline_Phosphatase==8888] <- NA

#Adding log-transformed CRP and adjusting serum creatinine according to published equation
Bio_III <- dplyr::transmute(Bio_III,SEQN=SEQN,CRP=CRP,Ln_CRP=log(CRP),Creatinine=(Creatinine*0.960-0.184),Albumin=Albumin, Alkaline_Phosphatase=Alkaline_Phosphatase,glucose=glucose)

#Extracting CBC biomarkers
Bio_cbc <- dplyr::select(lab,SEQN,LMPPCNT,WCPSI,MVPSI,RWP)

#Recoding missing and lower detection limit indicators to missing 

Bio_cbc$LMPPCNT[Bio_cbc$LMPPCNT==88888] <- NA
Bio_cbc$WCPSI[Bio_cbc$WCPSI==88888] <- NA
Bio_cbc$MVPSI[Bio_cbc$MVPSI==88888] <- NA
Bio_cbc$RWP[Bio_cbc$RWP==88888] <- NA

#Renaming to match continous dataframe
Bio_cbc <- dplyr::transmute(Bio_cbc,SEQN=SEQN,Lymphocyte_percent=LMPPCNT,White_Count=WCPSI,MCV=MVPSI,Red_Cell_Width=RWP)
```

#Combining NHANES III Data, removing extraneous files, & creating a dataframe to hold all data#

```{r}
Step2_III <- dplyr::left_join(Step1_III,Bio_III,by="SEQN")
Reference_III <- dplyr::left_join(Step2_III,Bio_cbc,by="SEQN")
dim(Reference_III)
summary(Reference_III)

#Converting creatinine from mg/dL to umol/L
Reference_III$PHENO_Creatinine <- Reference_III$Creatinine*88.42
#Converting glucose from mg/dL to mmol/L
Reference_III$PHENO_Glucose <- Reference_III$glucose*0.05551

#Removing extraneous files from global environment
rm(adult,lab,exam,Demo_III,BMI_III,Step2_III)

ALL_DATA <- dplyr::bind_rows(Data_continuous,Reference_III)
```


#Checking skewness and kurtosis & Windsorizing Data#
Changing approach to winsorize the reference and analytical dataset independently. Also winsorizing independently with sex within dataset.  

```{r}
library(moments)
library(DescTools)

#Winsorizing outliers in reference dataset 
Reference_III_men <- subset(Reference_III, Gender==1)
Reference_III_women <-subset(Reference_III, Gender==2)


Reference_Win_men <- dplyr::select(Reference_III_men,SEQN,CRP:PHENO_Glucose)
Reference_Win_men <- lapply(Reference_Win_men,Winsorize,minval=NULL,maxval=NULL,probs=c(0.01,0.99),na.rm=TRUE,type=7)
Reference_Win_men <- as.data.frame(Reference_Win_men)
Reference_Win_men <- dplyr::select(Reference_Win_men,CRP:PHENO_Glucose)
Temp <- dplyr::select(Reference_III_men,SEQN,WAVE,Age,Gender,Pregnant,BMI)
Reference_Win_men <- dplyr::bind_cols(Temp,Reference_Win_men)


Reference_Win_women <- dplyr::select(Reference_III_women,SEQN,CRP:PHENO_Glucose)
Reference_Win_women <- lapply(Reference_Win_women,Winsorize,minval=NULL,maxval=NULL,probs=c(0.01,0.99),na.rm=TRUE,type=7)
Reference_Win_women <- as.data.frame(Reference_Win_women)
Reference_Win_women <- dplyr::select(Reference_Win_women,CRP:PHENO_Glucose)
Temp <- dplyr::select(Reference_III_women,SEQN,WAVE,Age,Gender,Pregnant,BMI)
Reference_Win_women <- dplyr::bind_cols(Temp,Reference_Win_women)

#Winsorizing outliers in analytical dataset 
Analysis_men <- subset(Data_continuous,Gender==1)
Analysis_women <- subset(Data_continuous,Gender==2)

Analysis_Win_men <- dplyr::select(Analysis_men,SEQN,CRP:PHENO_Glucose)
Analysis_Win_men <- lapply(Analysis_Win_men,Winsorize,minval=NULL,maxval=NULL,probs=c(0.01,0.99),na.rm=TRUE,type=7)
Analysis_Win_men <- as.data.frame(Analysis_Win_men)
Analysis_Win_men <- dplyr::select(Analysis_Win_men,CRP:PHENO_Glucose)
Temp <- dplyr::select(Analysis_men,SEQN,WAVE,Age,Gender,Pregnant,BMI)
Analysis_Win_men <- dplyr::bind_cols(Temp,Analysis_Win_men)


Analysis_Win_women <- dplyr::select(Analysis_women,SEQN,CRP:PHENO_Glucose)
Analysis_Win_women <- lapply(Analysis_Win_women,Winsorize,minval=NULL,maxval=NULL,probs=c(0.01,0.99),na.rm=TRUE,type=7)
Analysis_Win_women <- as.data.frame(Analysis_Win_women)
Analysis_Win_women <- dplyr::select(Analysis_Win_women,CRP:PHENO_Glucose)
Temp <- dplyr::select(Analysis_women,SEQN,WAVE,Age,Gender,Pregnant,BMI)
Analysis_Win_women <- dplyr::bind_cols(Temp,Analysis_Win_women)
```


#Calculating LM Biological Age (Phenotypic Age)#
Phenotypic Age is calculated based on parameters published in the supplemental material of [Liu et al, 2018](https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1002718). Biomarkers were selected based on a Cox proportional hazard elastic net regression model for mortality with 10-fold cross validation. The actual algorithm is derived from two independent Gompertz proportional hazards models. One model fit using all 9 biomarkers + chronological age and a second model fit with only chronological age. These two models are equated to one another to calculate Phenotypic Age, or the chronological age at which risk for mortality is approximately normal. 

For now this only includes NHANES panels through 2010. 


```{r}
#Subsetting data
BA_NHANES_Parity <- dplyr::select(Analysis_Win_women,SEQN,WAVE,Age,Gender,Pregnant,BMI,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)
BA_NHANES_Parity <- subset(BA_NHANES_Parity,Pregnant==2 & Age<=84)

BA_NHANES_Parity <- BA_NHANES_Parity[complete.cases(BA_NHANES_Parity),]
dim(BA_NHANES_Parity)
summary(BA_NHANES_Parity)

#Calculating xb parameter
BA_NHANES_Parity <- dplyr::mutate(BA_NHANES_Parity,xb=-19.9067-0.0336*Albumin+0.0095*PHENO_Creatinine+0.1953*PHENO_Glucose+0.0954*Ln_CRP-0.0120*Lymphocyte_percent+0.0268*MCV+0.3306*Red_Cell_Width+0.00188*Alkaline_Phosphatase+0.0554*White_Count+0.0804*Age)
summary(BA_NHANES_Parity)
dim(BA_NHANES_Parity)

#Calculating cumulative distribution function (CDF)
BA_NHANES_Parity <- dplyr::mutate(BA_NHANES_Parity,CDF=1-(exp(-1.51714*exp(xb)/0.0076927)))

#If CDF=1, the PhenoAge is exponentiated to infinity. Therefore I'll recode these values to missing.  
BA_NHANES_Parity$CDF[BA_NHANES_Parity$CDF==1] <-NA

BA_NHANES_Parity <- dplyr::mutate(BA_NHANES_Parity,SEQN=SEQN,WAVE=WAVE,PhenoAge=141.50+(log(-0.00553*log(1-CDF))/0.09165))
summary(BA_NHANES_Parity$PhenoAge)
cor(BA_NHANES_Parity$PhenoAge,BA_NHANES_Parity$Age, use="pairwise.complete.obs")
```


#Calculating Homeostatic Dysregulation
Homeostatic dysregulation (HD) is calculated with respect ot a reference population. For HD the reference population is individuals aged 20-30 who are non-obese and whose biomarker values are all within age and sex specific norms defined [here](http://www.mayomedicallaboratories.com/). 


**Subsetting data**
Using cutoffs in the original units provided by Mayo instead of converting them. 

```{r}
#Reference dataframes by sex 
Reference_HD_women <- subset(Reference_Win_women, Gender==2 & Age>=20 & Age<=30 & BMI<30 & Pregnant==2 & Albumin>=35 & Albumin<=50 & Creatinine>=0.59 & Creatinine<=1.04 & glucose<126 & CRP<3 & Lymphocyte_percent>=28 & Lymphocyte_percent<=55 & MCV>=78.2 & MCV<=97.9 & Red_Cell_Width>=12.2 & Red_Cell_Width<=16.1 & Alkaline_Phosphatase>=35 & Alkaline_Phosphatase<=104 & White_Count>=3.4 & White_Count<=9.6)

Reference_HD_men <- subset(Reference_Win_men, Gender==1 & Age>=20 & Age<=30 & BMI<30 & Pregnant==2 & Albumin>=35 & Albumin<=50 & Creatinine>=0.74 & Creatinine<=1.35 & glucose<126 & CRP<3 & Lymphocyte_percent>=28 & Lymphocyte_percent<=55 & MCV>=78.2 & MCV<=97.9 & Red_Cell_Width>=11.8 & Red_Cell_Width<=14.5 & Alkaline_Phosphatase>=45 & Alkaline_Phosphatase<=109 & White_Count>=3.4 & White_Count<=9.6)

dim(Reference_HD_women)
dim(Reference_HD_men)
```


**Computing Reference Mean and Variance-Covariance Matrix**

```{r}
Reference_HD_women <- dplyr::select(Reference_HD_women,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)

Reference_HD_men <- dplyr::select(Reference_HD_men,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)

#Young healthy mean for women and men 
HD_mu_women <- lapply(Reference_HD_women,mean,na.rm=TRUE)
HD_mu_men <- lapply(Reference_HD_men,mean,na.rm=TRUE)
HD_mu_women <- unlist(HD_mu_women)
HD_mu_men <- unlist(HD_mu_men)
HD_mu_women
HD_mu_men

#Variance-covariance matrix. First create a reference dataframe with standardized values
Reference_HD_Standard_women <- scale(Reference_HD_women)
Reference_HD_Standard_men <- scale(Reference_HD_men)

S_women <- cov(Reference_HD_Standard_women,use="pairwise.complete.obs")
S_inv_women <- solve(S_women)
S_men <- cov(Reference_HD_Standard_men,use="pairwise.complete.obs")
S_inv_men <- solve(S_men)
```

**Computing HD for Participants in Analytical Sample**

```{r}
BA_HD_Calc_women <- subset(BA_NHANES_Parity,Gender==2)
# BA_HD_Calc_men <- subset(BA_NHANES_Parity,Gender==1)

BA_HD_Calc2_women <- dplyr::select(BA_HD_Calc_women,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)
BA_HD_Calc2_women <- BA_HD_Calc2_women[complete.cases(BA_HD_Calc2_women),]

# BA_HD_Calc2_men <- dplyr::select(BA_HD_Calc_men,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)
# BA_HD_Calc2_men <- BA_HD_Calc2_men[complete.cases(BA_HD_Calc2_men),]

library(stats)
#Calculated squared mahalanobis distance
BA_HD_Calc_women$HDsquare <- mahalanobis(BA_HD_Calc2_women,HD_mu_women,S_inv_women,inverted=FALSE)
# BA_HD_Calc_men$HDsquare <- mahalanobis(BA_HD_Calc2_men,HD_mu_men,S_inv_men,inverted=FALSE)
#Square root is HD 
BA_HD_Calc_women$HD <- sqrt(BA_HD_Calc_women$HDsquare)
# BA_HD_Calc_men$HD <- sqrt(BA_HD_Calc_men$HDsquare)


BA_HD_women <- dplyr::select(BA_HD_Calc_women,SEQN,HD)
# BA_HD_men <- dplyr::select(BA_HD_Calc_men,SEQN,HD)
# BA_HD <- dplyr::bind_rows(BA_HD_women,BA_HD_men)

BA_NHANES_Parity <- dplyr::full_join(BA_NHANES_Parity,BA_HD_women,by="SEQN")
BA_NHANES_Parity$LOG_HD <- log(BA_NHANES_Parity$HD)
summary(BA_NHANES_Parity$LOG_HD)
cor(BA_NHANES_Parity$LOG_HD,BA_NHANES_Parity$Age, use="pairwise.complete.obs")
```

#Building KDM Parameters 

**Subsetting data**

```{r}
#The "pregnant" variable is a dichotomous indicator of whether the participant is a pregnant female (1) or a non-pregnant female/male (2) 
subset_age_nopreg <- subset(Reference_Win_women, Age>=30 & Age <=75 & Pregnant==2)

#We'll need this further subsetted to men and women to calculate the model parameters for each individual biomarker (i.e. correlations, intercept, slope, error)
# subset_men <- subset(subset_age_nopreg, Gender==1)
subset_women <- subset(subset_age_nopreg, Gender==2)

#Replace the biomarkers listed here with the variable names of the biomarkers in your panel. Any transformations (e.g. log) should be done prior to this step. CHRONOLOGICAL AGE NEEDS TO BE THE FIRST VARIABLE. 

#If you add dummy variables to use in later regressions (e.g. NHANES Wave), those should be added in columns AFTER those holding all of the biomarkers.     

# subset_men <- dplyr::select(subset_men,Age,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)

subset_women <- dplyr::select(subset_women,Age,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count)
```

**Calculating correlations and characteristic correlations (Rchar; Equation 4 in Levine 2013) for men and women**

```{r}

# correlations_men <-list()
# for(i in 2:ncol(subset_men)) {
#  correlations_men[[i]] <- cor(subset_men[,1],subset_men[,i],use="pairwise.complete.obs")
# }
# correlations_men <- unlist(correlations_men)


correlations_women <-list()
for(i in 2:ncol(subset_women)) {
  correlations_women[[i]] <- cor(subset_women[,1],subset_women[,i],use="pairwise.complete.obs")
}
correlations_women <- unlist(correlations_women)

#Change j to match the number of biomarkers in your panel. For example a 10 biomarker panel would have j <- 1:10.
j <- 1:9
# Rchar_men <- (sum((correlations_men[j]^2)/(sqrt(1-(correlations_men[j])^2))))/(sum((correlations_men[j])/(sqrt(1-(correlations_men[j])^2))))

Rchar_women <- (sum((correlations_women[j]^2)/(sqrt(1-(correlations_women[j])^2))))/(sum((correlations_women[j])/(sqrt(1-(correlations_women[j])^2))))

# Rchar_men
Rchar_women
```

**Calculating model parameters (slope, intercept, root mean squared error) for men and women**
DOES NOT INCLUDE DUMMY CODING FOR NHANES WAVES! These factors can be added to the regression statements on line 73 and 84. I.e. lm(subset_men[,i]~subset_men$Age+DUMMY1+DUMMY2+etc.). 

```{r}
#Replace the number of rows here with the number of biomarkers you are using. For example a 10 biomarker panel would have "nrow=10"
# parameters_men <- matrix(nrow=9,ncol=3)
# colnames(parameters_men) <- c("Intercept","Slope","RMSE")
# hold <- list()
# for(i in 2:ncol(subset_men)) {
#  hold[[i]] <- lm(subset_men[,i]~subset_men$Age)
#  parameters_men[[i-1,1]] <- hold[[i]]$coefficients[1]
#  parameters_men[[i-1,2]] <- hold[[i]]$coefficients[2]
#  parameters_men[[i-1,3]] <- sqrt((c(crossprod(hold[[i]]$residuals)))/(length(hold[[i]]$residuals)))
# }

#Replace the number of rows here with the number of biomarkers you are using 
parameters_women <- matrix(nrow=9,ncol=3)
colnames(parameters_women) <- c("Intercept","Slope","RMSE")
hold <- list()
for(i in 2:ncol(subset_women)) {
  hold[[i]] <- lm(subset_women[,i]~subset_women$Age)
  parameters_women[[i-1,1]] <- hold[[i]]$coefficients[1]
  parameters_women[[i-1,2]] <- hold[[i]]$coefficients[2]
  parameters_women[[i-1,3]] <- sqrt((c(crossprod(hold[[i]]$residuals)))/(length(hold[[i]]$residuals)))
}
```

**Calculating BAe (Equation 2 in Levine 2013) for men and women**

```{r}
# BAe_men <- list()
# for(i in 1:nrow(subset_men)) {
#  BAe_men[[i]] <- sum((subset_men[i,j+1]-parameters_men[j,1])*((parameters_men[j,2])/(parameters_men[j,3]^2)))/sum(((parameters_men[j,2])/(parameters_men[j,3]))^2)
# }
# BAe_men <- unlist(BAe_men)

BAe_women <- list()
for(i in 1:nrow(subset_women)) {
  BAe_women[[i]] <- sum((subset_women[i,j+1]-parameters_women[j,1])*((parameters_women[j,2])/(parameters_women[j,3]^2)))/sum(((parameters_women[j,2])/(parameters_women[j,3]))^2)
}
BAe_women <- unlist(BAe_women)
```

**Calculating SBA2 (Equation 5 in Levine 2013) for men and women**
This block is somewhat limited as I've resricted the calculation to only include those individuals with complete data. This amount might be increased with multiple imputation or with a weighting strategy, but I have not explored those approaches yet. 

```{r}

#Subseting the data again to only include those cases with full data.  
# subset2_men <- subset_men[complete.cases(subset_men),]
subset2_women <- subset_women[complete.cases(subset_women),]

# i <- 1:nrow(subset2_men)

# SBA2_men <- (sum(((BAe_men[i]-subset2_men[i,1]) - (sum((BAe_men[i]-subset2_men[i,1])/(length(which(!is.na(BAe_men)))),na.rm=TRUE)))^2,na.rm=TRUE)/(length(which(!is.na(BAe_men))))) - ((1-Rchar_men^2)/(Rchar_men^2))*(45^2)/(12*length(j))

i <- 1:nrow(subset2_women)

SBA2_women <- (sum(((BAe_women[i]-subset2_women[i,1]) - (sum((BAe_women[i]-subset2_women[i,1])/(length(which(!is.na(BAe_women)))),na.rm=TRUE)))^2,na.rm=TRUE)/(length(which(!is.na(BAe_women))))) - ((1-Rchar_women^2)/(Rchar_women^2))*(45^2)/(12*length(j))

# SBA2_men
SBA2_women
```             
             
**Creating subsets of the analysis sample for calculation of KDM Biological Age**

```{r}
mydata_subset <- dplyr::select(BA_NHANES_Parity,Age,Albumin,PHENO_Creatinine,PHENO_Glucose,Ln_CRP,Lymphocyte_percent,MCV,Red_Cell_Width,Alkaline_Phosphatase,White_Count,SEQN,Gender)
# mydata_men <- subset(mydata_subset,Gender==1 & Age<=84)
mydata_women <- subset(mydata_subset,Gender==2 & Age<=84)


#Creating empty dataframes with length the same as those for mydata_men/women but which will hold SEQN.
hold <- dplyr::select(BA_NHANES_Parity,SEQN,Gender)
# hold_men <- subset(hold,Gender==1)
hold_women <- subset(hold,Gender==2)
```

**Calculating KDM Biological Age (Equation 3 in Levine 2013) for Men and Women in the Analysis Sample**


```{r}
#Replace 'mydata_men' with the name of your sample/analysis dataset, which should be filtered to only include men. Chronological age is assumed to be in the first column, followed by the biomarkers in an order consistent with all other steps.    
# KDM_men <- list()
# for(i in 1:nrow(mydata_men)) {
#  KDM_men[[i]] <- (sum((mydata_men[i,j+1]-parameters_men[j,1])*((parameters_men[j,2])/(parameters_men[j,3]^2)))+((mydata_men[i,1])/(SBA2_men)))/(sum(((parameters_men[j,2])/(parameters_men[j,3]))^2)+1/SBA2_men)
# }
# KDM_men <- unlist(KDM_men)

#Replace 'mydata_women' with the name of your sample/analysis dataset, which should be filtered to only include women. Chronological age is assumed to be in the first column, followed by the biomarkers in an order consistent with all other steps.   
KDM_women <- list()
for(i in 1:nrow(mydata_women)) {
  KDM_women[[i]] <- (sum((mydata_women[i,j+1]-parameters_women[j,1])*((parameters_women[j,2])/(parameters_women[j,3]^2)))+((mydata_women[i,1])/(SBA2_women)))/(sum(((parameters_women[j,2])/(parameters_women[j,3]))^2)+1/SBA2_women)
}
KDM_women <- unlist(KDM_women)
```

**Combining Data for Final Output**

If your "mydata" files are already structured as a dataframe you could simply add the KDM values to the existing files with the following statement "mydata_men$KDM <- KDM_men". Similarly for women. 

```{r}
#hold_men <- dplyr::select(hold_men,SEQN)
# hold_men$KDM <- KDM_men

hold_women <- dplyr::select(hold_women,SEQN)
hold_women$KDM <- KDM_women

# hold_both <- dplyr::bind_rows(hold_men,hold_women)
BA_NHANES_Parity <- dplyr::full_join(BA_NHANES_Parity,hold_women,by="SEQN")
cor(BA_NHANES_Parity$KDM,BA_NHANES_Parity$Age, use="pairwise.complete.obs")
```

#Exporting Final Dataset

```{r}
library(foreign)
write.foreign(as.data.frame(BA_NHANES_Parity),"C:/Users/wjh180/Box/Working Files/BA and Parity/BA_NHANES_Parity.txt","C:/Users/wjh180/Box/Working Files/BA and Parity/BA_NHANES_Parity.sps", package="SPSS")
```

